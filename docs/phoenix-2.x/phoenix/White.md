---
id: phoenix-white-page-2x
title: Phoenix 白皮书
---

## 白皮书撰写要点
1. Q: 核心内容的覆盖范围是什么？在这个版本中介绍的phoenix暂时不包含事务可靠性的能力？那么这个版本的能力是否与phoenix微服务化的定位不符？
A: 事务能力在概述中提及，不展开具体方案。
2. Q: 白皮书中是否提及Akka对phoenix提供的相关技术底层支持（如分布式Sharding、聚合根负载均衡、横向扩张能力和伸缩能力）？
A: 可以说明借助AKKA实现，不细讲其中原理。提及其为Phoenix带来的以上能力。
3. 名词统一：
    - 多活/多实例/集群/分布式
    - 聚合/聚合根
4. 明确定义：Phoenix应属于消息驱动架构，事件驱动架构是一个更广泛的概念，所有对事件有响应的程序都可称为事件驱动；但程序设计对事件定义的耦合性，在不同的实现下其程度有所不同。通过自定义的消息和响应逻辑，消息驱动方式在模块耦合度上更低。

### 注意用词
* 消息中间件/消息队列 -> 统一使用消息队列，在突出架构组成和部署方面时才使用“消息中间件”。

## 引言（背景）
> 行业或领域内发展现状和前景分析。
> 原《白皮书》中的内容可以直接引用：
> 要点：
>   1. 资管行业市场的要求变化，需要精细化管理、高效和智能。
>   2. 资管系统业务复杂度高，涉及模块广，覆盖业务种类多，要求模块间松耦合。
>   3. 系统需要承载大规模分析计算，保证高响应。
>   4. 要求系统模块可以独立快速迭代、部署。
>   5. 目前现状：业务逻辑基于数据库和存储过程，单体化架构，模块紧耦合，开发交付周期长，性能低，可用性低，扩展性差等。
>   6. （不需要，后段Phoenix介绍衔接）Phoenix的目标和定位？

随着中国社会财富的迅速膨胀和资管新规的推出，资产管理行业出现了新的发展趋势。首先是一系列监管规则推出，推动资产管理回归本源，对于资产管理人的资产主动管理能力提升产生了强烈诉求。再者，客户特别是机构客户的认知和能力的提升，倒逼资产管理机构要提供更加专业的服务能力。第三，市场越来越充分的竞争，使得所有的资产管理机构都要往精细化管理方向转型。最后，以专户管理为标志的客户个性化、专业化服务的诉求使得管理人也面临创新压力。这些发展趋势，使得整个行业对新型的、高效的、更智能的资产管理系统平台的需求变得越来越迫切。

众所周知，资管系统所承载的业务复杂度极高，涉及到的模块广：组合、交易、头寸、风控、估值、归因、风险等等，覆盖的业务种类多：固收、权益、期货、衍生品、非标等等。这样的业务复杂性，需要系统做到模块化及模块间松耦合，保障模块彼此间不会有“腐败传导”，并且可进行独立升级、优化，通过重新排定组件来应对业务流程的快速改变需求。

当前的资管业务的发展趋势是往数量化、模型驱动型投资管理模式方向发展，要求业务系统在保持很好的操作型能力的同时，还要进行大量的分析计算，这就要求资管系统逐步转型为以分析管理型能力为主的系统。而且，交互型系统需要更加好地符合业务快速响应的能力，强调用户体验和交互的逻辑性，部署和迭代更新足够快，要求这类型系统能够尽可能多地围绕客户体验和场景来打造。
以上这些资管行业的发展与新一代资管系统的发展特点，都要求配套的技术体系建设从设计思想、架构设计、实现技术等方面都要有新的突破，尤其是系统架构和底层基础平台方面，需要做重新的设计。

目前，行业普遍使用基于数据库和存储过程等技术来开发资管系统，支持业务的发展。这些系统其特点是偏操作型，注重流程的处理，所采用的单体化架构，技术相对老旧，功能模块采用紧耦合，导致其开发模式很重，变更交付周期长，无法适应现代资管行业的各种业务创新多、客户需求响应快、分析计算量大等需求，后期架构虽然有所优化，但是没有发生根本性的变化，依然存在有一些缺点，比如在扩展性、可用性、性能瓶颈的解决方案上，都有明显的弱点。
所以，以新架构、新技术、新模式打造新一代资管系统，变得极其迫切。同时，行业机构都开始大力发展金融科技能力，自主研发成为IT战略的核心建设内容之一。如何利用成熟技术解决自主研发能力和有限资源的问题，也是一个亟待解决的新课题。


## Phoenix概述（介绍）
> 使用高度概括的文字进行简短描述：
> * （What）Phoenix是什么？
> * （Why）为什么需要Phoenix？
> * （How）Phoenix的能力、方案和优势？
>
> 原《白皮书》中内容可以直接引用
> 要点：（原白皮书中本章节使用精简概要的文字综述了以下Phoenix能应对以上场景要求的特性能力）
>   1. Phoenix是什么：Phoenix是宽拓自主研发的一款事件驱动型（应为消息驱动）的高性能Java开发框架。（事件驱动还是消息驱动？）
>   2. 目标：金融行业的应用系统业务复杂性高、性能要求高，Phoenix专注于降低这些应用系统的开发难度，并满足性能要求。
>   3. 能力：封装了复杂的底层实现，提供稳定、可靠和高性能的内存计算能力（“提供强大的内存保护机制”？）。
>   4. 能力：支持有状态服务的分布式计算（这里不是指分布式事务的概念，是指多节点算力负载均衡）、动态伸缩和横向扩展能力。
>   5. 理念、特点：Phoenix是一种微服务架构。
>   6. （是否在这里提及？）能力：提供了分布式事务处理引擎（分布式事务解决方案），满足数据一致性要求。
>   7. 解决方案：提供强大的实时监控、在线管理平台。
>   8. 能力：DevOps工具，提供持续集成，提高交付、部署能力。
> 
> TODO: 
>   1. 检查以上描述的要点是否有重点被遗漏。
>   2. 当前的Phoenix的整体概述可能已经不适用，在写完以下架构介绍和特点特性介绍后，通过对以下内容进行总结，得到最后的Phoenix整体概述。
>

Phoenix是宽拓自主研发的一款消息驱动型的高性能Java开发框架，专注于降低金融行业中业务复杂性高、性能要求高的应用系统的开发难度，助力研发团队打造专业、高效的微服务化的金融应用系统。Phoenix框架封装了复杂的底层技术，提供强大的内存保护机制，为应用提供极高的稳定性、基于内存的高性能的计算能力和动态伸缩扩展的能力，匹配当前和未来金融领域海量数据实时分析的强烈算力需求。同时，针对行业技术架构往微服务迁移的发展趋势和微服务架构使用的核心挑战，Phoenix提供了分布式事务处理引擎，满足金融领域微服务应用间的业务完整性、数据一致性的要求。除此之外，Phoenix还提供了强大的实时监控和在线管理功能，为系统高效智能运维提供了基础。搭配DevOps工具，提升了研发的持续集成和交付能力。

## Phoenix架构设计
> 总述Phoenix架构形态，分为两个方面描述：架构组成方面和业务模型开发方面，提供一个整体的架构视角。
> 这里的分述不以特性、特点为单位，以某个实际问题的解决方案和架构设计为单位，进行分点描述。
> 涉及到技术特性细节可以不细讲，具体实现可以放到底下框架特性中介绍。

>   * [x] 基于事件驱动：客户端和服务层数据通讯交互方式为消息队列(MQ)（以后可支持HTTP，这里暂不提及）。
>   * [x] 客户端调用支持异步和同步方式。
>   * [x] 实现EventStore作为服务状态存储。 -> 解决纯内存计算带来的问题，介绍EventSourcing方案，EventStore为重要的方案组成。（可以提及快照）
>   * [x] 无侵入插件支持：Phoenix-Persist上报数据到ElasticSearch，结合Grafana做实时监控。
>   * [x] Phoenix-Admin运维监控平台，通过注册中心对服务进行发现和管理。
>   * [x] 消息路由机制。
>   * [x] DDD模式的一种实现框架：以业务划分的角度描述Aggregate（聚合）模型 -> 模块化划分。（在段落综述中提及）
>   * [x] 基于Actor模型实现以一个聚合对象为最小并发粒度的高并发计算。
>   * [x] 借助Akka Cluster/Akka Sharding使得聚合对象分散在一个多活的服务集群中，提供横向扩展能力。（以上两点在特点特性中详细介绍实现方式）
>   * [ ] 补充整体视角的架构图。

Phoenix是一套（准）微服务开发框架。在应用系统架构方面，提供了包括客户端开发、服务端开发、消息通讯架构、服务端状态存储和恢复、计算层和消息层监控、服务端运维等架构方案。而在业务开发方面，Phoenix提供了一套领域驱动设计模式(DDD)的实现模型，业务开发中的领域模型定义以聚合对象(Aggregate)的形式作为业务计算的基本单元，聚合对象之间仅以消息(Message)作为数据交互接口，通过消息中间件实现消息通讯。

### 消息通讯层
Phoenix架构中，业务计算以领域聚合模型为基本单元，这些基本单元对应着实际业务的一个个实体对象，它们之间的数据交换通过相互发送消息进行。聚合对象不仅需要和客户端数据交换，还要与其他领域的聚合对象进行数据交换，这些跨领域的聚合对象数据交互都通过消息队列实现。目前Phoenix消息通讯层使用Kafka实现，每个服务有其绑定的Topic，服务之间进行消息发送时根据服务名和目标聚合对象的信息进行路由。

> 补充示意图：描述客户端-服务端-消息队列数据交互模型。

### 客户端-服务端交互
Phoenix框架中客户端和服务端的数据交互基于消息队列，并且框架为客户端提供了业务调用接口。当领域聚合模型和消息定义好之后，客户端通过消息通讯层向服务端发送相应的业务请求消息即可触发业务服务计算。在完成计算后，客户端可接收该请求的处理结果（同样为消息形式），完成一个业务请求的远程调用。业务调用为异步消息驱动，客户端或服务端调用方可以在发起调用后处理后续任务，实现非阻塞异步调用。同时，客户端也支持对业务的同步调用，调用线程在等待业务处理结果时被阻塞，至到业务处理结果被返回或调用超时。

### 计算层架构（服务端）
Phoenix开发的应用架构中所有服务端（Phoenix服务）形成应用架构的计算层。这些服务端一般为有状态(Stateful)的内存计算(In-Memory)服务，有状态即业务的计算依赖于服务当前的状态，内存计算则是在进行业务计算时，其依赖的数据都已经预先加载到内存中，数据模型不依赖。对于具体业务模型而言，其数据模型不会直接映射外部存储（数据库）的数据模型，也就是说，这些数据模型的查询和修改，不依赖外部存储，仅面向内存模型进行交互，减少因复杂的数据模型存储带来的性能影响。

为了保障Phoenix服务的状态可恢复，领域聚合对象的所有状态变更都基于领域事件(DomainEvent)进行增量更新，即聚合对象的所有状态都可以通过重跑领域事件来恢复。储存这些领域事件的存储层即为EventStore，服务在运行期间将领域事件存储到EventStore中，如果某个服务节点发生宕机，则该节点可以在重启后从EventStore中读取相应的领域事件恢复出宕机前的状态，而这个过程即是EventSourcing。

另一方面，为了满足服务在高并发场景下的处理能力，框架借助Akka的Actor计算模型在线程级别上提供以聚合对象为最小单位的并发粒度；同时基于Akka-Cluster和Akka-Sharding实现，相同领域的Phoenix服务可以进行多节点集群部署，构建多活集群，集群中不同的聚合根对象均衡地分布在不同节点中，使得服务可以通过增加节点的方式对系统的处理能力进行横向扩展。

> 补充示意图：（1）服务与EventStore的架构关系；（2）服务多活集群示意；

### 消息层监控和分析
由于Phoenix服务的所有数据交互都是基于消息队列，所以我们可以通过对消息队列中的消息进行消费读取的方式，很方便的对系统中流转的消息进行监控和分析。基于这些消息，Phoenix提供了一套消息层监控分析方案。在应用系统中部署一个消息持久化服务消费所有Topic队列的消息，该服务会将消费到的消息持久化到Elasticsearch存储中，随后，我们便可以使用Grafana连接上Elasticsearch存储，对消息进行监控和分析。系统中流转的消息反应着系统的运行状态，如果能合理监控和分析这些消息，应用系统将具备业务告警、业务分析和问题排查等强大的能力。

### Phoenix-Admin服务监控平台
Phoenix-Admin是配合Phoenix框架使用的服务监控平台，能够实现对多个项目，多服务，多实例层级的监控和内存管理的功能。微服务化的系统架构下，服务模块数量众多，加之每个领域服务都可以各自进行集群化多活部署，服务实例的数量只增不减，这对系统的监控和运维带来极大挑战。Phoenix-Admin通过注册中心对各服务实例进行注册，配合Phoenix服务中提供的服务监控管理接口，提供了不少方便监控和运维管理的手段。

> 详细的可以继续补充。

## Phoenix技术特性
> 技术特性的文字撰写形式建议：每个点使用综述性的段落文字描述该特性的简要说明和实现要点，适当的配以说明图例，提及高特性可以给系统带来的能力和优势。

### 内存计算

### 微服务

### 消息驱动
> 撰写本小节前先确定消息驱动和事件驱动的定义和两者的区别，准确定位Phoenix具备的是哪种特性？

### 高性能
> 介绍Phoenix中以性能为导向的特性，通过描述性的文字分别介绍以下特性如何为Phoenix带来高性能。
> 疑问：“多活”和“动态横向扩展”是否应在“高性能”特点下介绍？我这里理解“多活/多实例”和“横向扩展”能力不属于能够说明Phoenix是高性能框架的特点，Phoenix高性能的主要

* 无锁
> 疑问：原《白皮书》中，在“特点-高性能”小节中，提及了“无锁”的特点？这里缺乏准确定义。

* 事件驱动
> 区分事件驱动和消息驱动，确定用词口径

* 高并发
> 分别以单节点内多线程的使用和分布式多节点的角度阐述高并发能力

* 内存计算(In-Memory)
> EventSourcing和快照作为解决内存计算架构中状态可恢复和可靠性问题的两个解决方案

* 读写分离(CORS)
> 简单阐述读写分离与高性能的关系？
> CQRS在Phoenix框架中的体现在哪里？如：基于事件响应和事件存储能力，可以将C端和Q端分离独立

* 高扩展性（主要为横向扩展能力）
> 以服务节点为颗粒度的横向扩展能力

### 伸缩性
### 高可用性

## 运维监控平台
> 介绍Admin

## 总结与展望
> 总结，当前的局限性和问题，往后的技术路线