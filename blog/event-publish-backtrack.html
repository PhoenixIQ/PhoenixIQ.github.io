<!doctype html>
<html lang="zh-cn" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.0">
<title data-rh="true">EventPublish 的回溯和去重 | Phoenix</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="http://phoenix-website.sz.iquantex.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="http://phoenix-website.sz.iquantex.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="http://phoenix-website.sz.iquantex.com/blog/event-publish-backtrack"><meta data-rh="true" property="og:locale" content="zh_cn"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="EventPublish 的回溯和去重 | Phoenix"><meta data-rh="true" name="description" content="在 2.6.0 中, 我们实现了 EventPublish 的回溯和去重机制，修复了之前在部分极端场景下可能出现数据库漏读的问题。"><meta data-rh="true" property="og:description" content="在 2.6.0 中, 我们实现了 EventPublish 的回溯和去重机制，修复了之前在部分极端场景下可能出现数据库漏读的问题。"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-11-11T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/roiocam"><meta data-rh="true" property="article:tag" content="Phoenix,EventPublish,Backtrack"><link data-rh="true" rel="icon" href="/img/phoenix.png"><link data-rh="true" rel="canonical" href="http://phoenix-website.sz.iquantex.com/blog/event-publish-backtrack"><link data-rh="true" rel="alternate" href="http://phoenix-website.sz.iquantex.com/blog/event-publish-backtrack" hreflang="zh-cn"><link data-rh="true" rel="alternate" href="http://phoenix-website.sz.iquantex.com/blog/event-publish-backtrack" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Phoenix RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Phoenix Atom Feed">




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.565e9082.css">
<script src="/assets/js/runtime~main.6fcc6c0f.js" defer="defer"></script>
<script src="/assets/js/main.2f4bde00.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Phoenix Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo_dark.png" alt="Phoenix Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">首页</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">文档</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/introduce">介绍</a></li><li><a class="dropdown__link" href="/docs/phoenix">快速入门</a></li><li><a class="dropdown__link" href="/docs/phoenix-core">Phoenix 框架</a></li><li><a class="dropdown__link" href="/docs/phoenix-transaction">Phoenix 事务</a></li><li><a class="dropdown__link" href="/docs/phoenix-observability">Phoenix 可观测性</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/introduce">latest</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/introduce">latest</a></li><li><a class="dropdown__link" href="/docs/2.6.0/introduce">2.6.0</a></li><li><a class="dropdown__link" href="/docs/2.5.5/phoenix-2.x/phoenix/phoenix-introduce">2.5.5</a></li><li><a class="dropdown__link" href="/docs/2.5.4/phoenix-2.x/phoenix/phoenix-introduce">2.5.4</a></li><li><a class="dropdown__link" href="/docs/2.5.3/phoenix-2.x/phoenix/phoenix-introduce">2.5.3</a></li><li><a class="dropdown__link" href="/docs/2.5.2/phoenix-2.x/phoenix/phoenix-introduce">2.5.2</a></li><li><a class="dropdown__link" href="/docs/2.5.1/phoenix-2.x/phoenix/phoenix-introduce">2.5.1</a></li><li><a class="dropdown__link" href="/docs/2.5.0/phoenix-2.x/phoenix/phoenix-introduce">2.5.0</a></li><li><a class="dropdown__link" href="/docs/2.4.4/phoenix-2.x/phoenix/phoenix-introduce">2.4.4</a></li><li><a class="dropdown__link" href="/docs/2.4.3/phoenix-2.x/phoenix/phoenix-introduce">2.4.3</a></li><li><a class="dropdown__link" href="/docs/2.4.2/phoenix-2.x/phoenix/phoenix-introduce">2.4.2</a></li><li><a class="dropdown__link" href="/docs/2.4.1/phoenix-2.x/phoenix/phoenix-introduce">2.4.1</a></li><li><a class="dropdown__link" href="/docs/2.4.0/phoenix-2.x/phoenix/phoenix-introduce">2.4.0</a></li><li><a class="dropdown__link" href="/docs/2.2.4/phoenix-2.x/phoenix">2.2.4</a></li></ul></div><a href="https://github.com/PhoenixIQ" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/event-publish-backtrack">EventPublish 的回溯和去重</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2.6.x-migration-guide">Phoenix 2.6.0 迁移指南</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2.6.x-release">Phoenix 2.6.x Release</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/phoenix-tuning">Phoenix 性能调优</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/phoenix-scene">Phoenix 使用场景介绍</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="在 2.6.0 中, 我们实现了 EventPublish 的回溯和去重机制，修复了之前在部分极端场景下可能出现数据库漏读的问题。"><header><h1 class="title_f1Hy" itemprop="headline">EventPublish 的回溯和去重</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-11-11T00:00:00.000Z" itemprop="datePublished">2023年11月11日</time> · <!-- -->阅读需 11 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/roiocam" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/26020358?v=4" alt="jingzhang.chen" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/roiocam" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">jingzhang.chen</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><blockquote>
<p>在 2.6.0 中, 我们实现了 EventPublish 的回溯和去重机制，修复了之前在部分极端场景下可能出现数据库漏读的问题。</p>
</blockquote>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="eventpublish-的挑战1-性能">EventPublish 的挑战1: 性能<a href="#eventpublish-的挑战1-性能" class="hash-link" aria-label="EventPublish 的挑战1: 性能的直接链接" title="EventPublish 的挑战1: 性能的直接链接">​</a></h2>
<p>在 Phoenix 2.6.0 版本中，为了提升 EventPublish 的读取性能，我们重构了 EventPublish 的核心部分。在这个过程中，我们发现了一些需要解决的问题。让我们首先了解一下 EventPublish 的定义和实现：</p>
<p>EventPublish 实际上是 EventSourcing 中全局事件流的一个投影。全局事件流需要严格有序，否则，多个聚合根的交互可能会导致事件顺序（时间）不一致的问题（例如：在Saga场景下）。
因此，EventPublish使用 <code>create_time</code> 字段作为查询索引，且严格按照时间顺序进行排序。同时，我们使用数据库(MySQL)提供的 <code>CURRENT_TIMESTAMP()</code> 函数作为时间字段的插入值（使用了单点的时间戳，能避免<a href="https://en.wikipedia.org/wiki/Logical_clock" target="_blank" rel="noopener noreferrer">分布式系统的事件顺序问题</a>）</p>
<p>为了降低EventPublish到消费者之间的延迟，我们采用了分页和范围查询来加速数据库查询，从而减少端到端的延迟。</p>
<p>然而，在高吞吐量的应用场景下，这些机制仍可能会引发问题： <strong>在我们的性能测试中发现，写入是并行的，而查询则是单线程的。在分页查询的场景下，即使数据库响应时间只有10ms，我们也需要每秒执行超过100次的数据库查询。</strong></p>
<p>写入和查询速度的不匹配导致了生产者和消费者之间的问题，事件在数据库中积压，查询范围随着时间的推移而增大。根据 <a href="https://dev.mysql.com/doc/refman/8.0/en/where-optimization.html" target="_blank" rel="noopener noreferrer">MySQL 查询优化文档</a>:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Each table index is queried, and the best index is used unless the optimizer believes that it is more efficient to use a table scan. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">At one time, a scan was used based on whether the best index spanned more than 30% of the table, but a fixed percentage no longer determines the choice between using an index or a scan. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The optimizer now is more complex and bases its estimate on additional factors such as table size, number of rows, and I/O block size.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当EventPublish Reader的事件消费速率落后于总行数的30%时，索引将失效，查询将退化为全表扫描，这会导致数据库查询的QPS下降到2000/s，消费落后的问题将更加严重。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="动态边界索引">动态边界(索引)<a href="#动态边界索引" class="hash-link" aria-label="动态边界(索引)的直接链接" title="动态边界(索引)的直接链接">​</a></h3>
<p>为了解决该问题，Phoenix 在内部对范围查询的边界进行了动态调整：</p>
<ul>
<li>当单次查询条件<code>(当前 Offset, 数据库时间 - 1s)</code>下，返回的结果等于查询分页的大小时，EventPublish Reader 则认为当前需要分页， 并进入分页模式</li>
<li>在分页模式下，查询条件变成了<code>(当前 Offset, 第一次响应结果集合中的最大时间戳)</code>，直到分页模式下查询的结果小于分页大小</li>
<li>在分页模  式下，数据库响应集合大小低于分页大小，退出分页模式，使用：<code>(当前 Offset, 数据库时间 - 1s)</code> 作为索引查询</li>
</ul>
<p>这种分页机制下，虽然在长时间高吞吐量下，EventPublish 有可能会不断在普通模式和分页模式之间来切换，但相对于全表扫描，索引的利用率更高。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="eventpublish-的挑战2-完整性">EventPublish 的挑战2: 完整性<a href="#eventpublish-的挑战2-完整性" class="hash-link" aria-label="EventPublish 的挑战2: 完整性的直接链接" title="EventPublish 的挑战2: 完整性的直接链接">​</a></h2>
<p>在优化分页查询性能以及实现并行的 EventPublish Reader 后，EventPublish 的性能有了显著的提高。在我们内部的测试中，32 并行度的 EventPublish 能实现 15k/s 的 QPS。</p>
<p>然而，我们在 Phoenix 的 <a href="/docs/phoenix-console/phoenix-console-system-monitor">APM</a> 中
观察到在高吞吐量下 EventPublish 无法完整地发送所有事件。例如：插入了200,000条数据，但只读取到了199,888条数据，缺失了112条数据。经过详细的深入分析，我们认为EventPublish Reader存在漏读的现象，其主要原因如下：</p>
<p>根据 <a href="https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html#function_now" target="_blank" rel="noopener noreferrer">MySQL 的文档</a>（其他数据库同理）</p>
<blockquote>
<p>NOW() returns a constant time that indicates the time at which the statement began to execute.</p>
</blockquote>
<p>这意味着，它记录的是事务开始的时间，而不是事务提交的时间。因此，在Phoenix的持久化批量处理和 EventPublish 的时间戳读取过程中，可能会丢失一批持久化事件中处于批次尾部的事件。以下是示例说明：</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-eventstore-写入示例">1. EventStore 写入示例<a href="#1-eventstore-写入示例" class="hash-link" aria-label="1. EventStore 写入示例的直接链接" title="1. EventStore 写入示例的直接链接">​</a></h3>
<p>EventStore 的写入模式是批处理模式且由多线程执行。在某些极端条件下，可能会出现如下的情况：数据库在处理某一批中部的几个事件时，由于成本较高，导致这一批次尾部的事件无法及时创建快照。</p>
<p><img loading="lazy" src="/assets/images/database-f1586ae219f5d056457fa4ec17fb9ae0.png" width="1033" height="435" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-eventpublish-窗口滑动前">2 EventPublish 窗口滑动前<a href="#2-eventpublish-窗口滑动前" class="hash-link" aria-label="2 EventPublish 窗口滑动前的直接链接" title="2 EventPublish 窗口滑动前的直接链接">​</a></h3>
<p>对于运行速度够快的 EventPublish 而言（如下图：只有 Phoenix 手动延后的 1s 查询），此时当前时间窗口和上一批的写入可能还未完全完成，但是在本时间窗口内，EventPublish 已无法查询/读取到更多数据了。因此
EventPublish 将会滑动到下一个时间窗口。</p>
<p><img loading="lazy" src="/assets/images/event-publish-1-2a04cdf8cf15ab4d68d1588c0c217aae.png" width="1493" height="272" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-eventpublish-窗口滑动后">3. EventPublish 窗口滑动后<a href="#3-eventpublish-窗口滑动后" class="hash-link" aria-label="3. EventPublish 窗口滑动后的直接链接" title="3. EventPublish 窗口滑动后的直接链接">​</a></h3>
<p>在 EventPublish 的滑动过程中，可能数据库仍然会写入一些当前时间窗口的事件，但也有一种可能，直到当前时间窗口处理完毕，剩余的 &quot;8、9&quot; 事件仍未提交，因此对于 EventPublish 而言，&quot;8，9&quot; 事件相当于&quot;漏读&quot;了。</p>
<p><img loading="lazy" src="/assets/images/event-publish-2-bfce0701fd3738d1889954187104b720.png" width="1493" height="386" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="eventpublish-回溯机制">EventPublish 回溯机制<a href="#eventpublish-回溯机制" class="hash-link" aria-label="EventPublish 回溯机制的直接链接" title="EventPublish 回溯机制的直接链接">​</a></h2>
<p>为了解决 EventPublish 漏读问题，Phoenix 在 2.6.0 中为 EventPublish 增加了回溯机制，该机制主要的流程如下：</p>
<ul>
<li>实时检测读取事件流的完整性</li>
<li>检测事件漏读时，进行回溯查询以回填事件流间隙</li>
<li>事件去重机制</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-完整性校验">1. 完整性校验<a href="#1-完整性校验" class="hash-link" aria-label="1. 完整性校验的直接链接" title="1. 完整性校验的直接链接">​</a></h3>
<p>EventPublish 读取的是 EventSourcing 的全局投影，在全局维度上事件流的完整性难以检查（同一个时间可能写入多次，并无一个全局唯一的 UUID 字段），除非事件的唯一列使用自增的序列（这会带来写入的开销）。
但是我们可以从聚合根维度来检查其事件流的完整性，因为聚合根的版本是完全单调递增的序列。</p>
<p><img loading="lazy" src="/assets/images/backtrack-check-24c1609d7e2434348c6c7f03e9ee48d3.png" width="1967" height="595" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-回溯查询">2. 回溯查询<a href="#2-回溯查询" class="hash-link" aria-label="2. 回溯查询的直接链接" title="2. 回溯查询的直接链接">​</a></h3>
<p>回溯查询建立在完整性校验之上，当检查到事件缺失时，EventPublish 会停下并尝试获取缺失的事件直到该聚合根事件流缺失的事件序列被补齐，或者重试查询次数到达
<code>maxBackoff</code> 次数后，略过该段事件序列。</p>
<p><img loading="lazy" src="/assets/images/backtrack-query-8ab19fa116671b99f043ea6819ddff32.png" width="1315" height="714" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-去重机制">3. 去重机制<a href="#3-去重机制" class="hash-link" aria-label="3. 去重机制的直接链接" title="3. 去重机制的直接链接">​</a></h3>
<p>在支持了回溯查询后，可能存在一种特殊情况，在回溯查询之后的下一个查询窗口中，接收到&quot;已填充的的事件序列&quot;，此时需要将这些重复的事件进行去重过滤，
去重机制的实现与完整性校验机制几乎一样。</p>
<p><img loading="lazy" src="/assets/images/backtrack-deduplicate-3c2c74e3dd71b89b9f94824ca170f797.png" width="1435" height="836" class="img_ev3q"></p>
<p>对于为何在回溯查询后，会接收到已填充的事件序列，则是另一个原因。在先前本文已提到，写入是线程级并行的，因此当同一个聚合根的不同事件被分散到不同的聚合根之后，
由于线程调度的随机性，有可能同一个聚合根的高版本事件的数据库事务可能会先于较低版本的数据库事务开始。</p>
<p><img loading="lazy" src="/assets/images/concurrent-insert-5e1e2837e8bae161e89dfefd3c68137b.png" width="2286" height="455" class="img_ev3q"></p>
<p>去重是有意义的，可以避免重复发送事件，在异常重启或提交 offset 失败的情况下特别有用。另外，回溯方案的增加还能保证聚合根的事件顺序得到强一致的保证，这是一个额外的奖励。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="验证">验证<a href="#验证" class="hash-link" aria-label="验证的直接链接" title="验证的直接链接">​</a></h2>
<p>以每秒 6,000, 每秒 16,000 的案例各测试 100 秒，总共写入 2,200,000 事件的案例来对比回溯机制的实现前后</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="修复前">修复前<a href="#修复前" class="hash-link" aria-label="修复前的直接链接" title="修复前的直接链接">​</a></h3>
<p>在高频下（16,000）丢失了 1371 个事件， 而低频（6,000）下则基本无事件丢失。</p>
<p><img loading="lazy" src="/assets/images/before-backtrack-aafec2660e40e3c6f162bfc8e4197a5a.png" width="1075" height="682" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="修复后">修复后<a href="#修复后" class="hash-link" aria-label="修复后的直接链接" title="修复后的直接链接">​</a></h3>
<p>即使是在高频下（16,000）也无事件丢失。</p>
<p><img loading="lazy" src="/assets/images/after-backtrack-d8ed9d3d1b2e519bbd848e96e6cbf048.png" width="1075" height="682" class="img_ev3q"></p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/phoenix">Phoenix</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/event-publish">EventPublish</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/backtrack">Backtrack</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/PhoenixIQ/blog/2023-11-11-EventPublish-Backtrack.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/2.6.x-migration-guide"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">Phoenix 2.6.0 迁移指南</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#eventpublish-的挑战1-性能" class="table-of-contents__link toc-highlight">EventPublish 的挑战1: 性能</a><ul><li><a href="#动态边界索引" class="table-of-contents__link toc-highlight">动态边界(索引)</a></li></ul></li><li><a href="#eventpublish-的挑战2-完整性" class="table-of-contents__link toc-highlight">EventPublish 的挑战2: 完整性</a><ul><li><a href="#1-eventstore-写入示例" class="table-of-contents__link toc-highlight">1. EventStore 写入示例</a></li><li><a href="#2-eventpublish-窗口滑动前" class="table-of-contents__link toc-highlight">2 EventPublish 窗口滑动前</a></li><li><a href="#3-eventpublish-窗口滑动后" class="table-of-contents__link toc-highlight">3. EventPublish 窗口滑动后</a></li></ul></li><li><a href="#eventpublish-回溯机制" class="table-of-contents__link toc-highlight">EventPublish 回溯机制</a><ul><li><a href="#1-完整性校验" class="table-of-contents__link toc-highlight">1. 完整性校验</a></li><li><a href="#2-回溯查询" class="table-of-contents__link toc-highlight">2. 回溯查询</a></li><li><a href="#3-去重机制" class="table-of-contents__link toc-highlight">3. 去重机制</a></li></ul></li><li><a href="#验证" class="table-of-contents__link toc-highlight">验证</a><ul><li><a href="#修复前" class="table-of-contents__link toc-highlight">修复前</a></li><li><a href="#修复后" class="table-of-contents__link toc-highlight">修复后</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/introduce">Phoenix介绍</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/phoenix/quick-start-example/bookings-architecture">快速入门</a></li></ul></div><div class="col footer__col"><div class="footer__title">案例</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/PhoenixIQ/phoenix-samples/tree/master/bank-account" target="_blank" rel="noopener noreferrer" class="footer__link-item">账户管理<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/PhoenixIQ/phoenix-sample-risk" target="_blank" rel="noopener noreferrer" class="footer__link-item">交易风控<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/PhoenixIQ/phoenix-samples/tree/master/shopping-cart" target="_blank" rel="noopener noreferrer" class="footer__link-item">购物车<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/PhoenixIQ/hotel-booking" target="_blank" rel="noopener noreferrer" class="footer__link-item">酒店预订<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">资源</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">博客</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">北京宽拓智融科技有限公司 Copyright @2013 - 2023 iQuantex.com All Rights Reserved. 宽拓公司 版权所有</div></div></div></footer></div>
</body>
</html>