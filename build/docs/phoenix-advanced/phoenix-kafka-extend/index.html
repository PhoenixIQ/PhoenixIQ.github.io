<!doctype html>
<html lang="zh-cn" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-phoenix-advanced/phoenix-kafka-extend" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.0">
<title data-rh="true">Kafka 扩展 | Phoenix</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="http://phoenix-website.sz.iquantex.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="http://phoenix-website.sz.iquantex.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="http://phoenix-website.sz.iquantex.com/docs/phoenix-advanced/phoenix-kafka-extend"><meta data-rh="true" property="og:locale" content="zh_cn"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Kafka 扩展 | Phoenix"><meta data-rh="true" name="description" content="Phoenix 对 KafkaClient 的扩展，支持消息分块"><meta data-rh="true" property="og:description" content="Phoenix 对 KafkaClient 的扩展，支持消息分块"><link data-rh="true" rel="icon" href="/img/phoenix.png"><link data-rh="true" rel="canonical" href="http://phoenix-website.sz.iquantex.com/docs/phoenix-advanced/phoenix-kafka-extend"><link data-rh="true" rel="alternate" href="http://phoenix-website.sz.iquantex.com/docs/phoenix-advanced/phoenix-kafka-extend" hreflang="zh-cn"><link data-rh="true" rel="alternate" href="http://phoenix-website.sz.iquantex.com/docs/phoenix-advanced/phoenix-kafka-extend" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Phoenix RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Phoenix Atom Feed">




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.9b752ffb.css">
<script src="/assets/js/runtime~main.e6056bc2.js" defer="defer"></script>
<script src="/assets/js/main.1ba9e3a2.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Phoenix Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo_dark.png" alt="Phoenix Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">首页</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">文档</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/introduce">介绍</a></li><li><a class="dropdown__link" href="/docs/phoenix">快速入门</a></li><li><a class="dropdown__link" href="/docs/phoenix-core">Phoenix 框架</a></li><li><a class="dropdown__link" href="/docs/phoenix-transaction">Phoenix 事务</a></li><li><a class="dropdown__link" href="/docs/phoenix-observability">Phoenix 可观测性</a></li></ul></div><a class="navbar__item navbar__link" href="/blog/">博客</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/introduce">latest</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/phoenix-advanced/phoenix-kafka-extend">latest</a></li><li><a class="dropdown__link" href="/docs/2.6.0/phoenix-advanced/phoenix-kafka-extend">2.6.0</a></li><li><a class="dropdown__link" href="/docs/2.5.5/phoenix-2.x/phoenix/phoenix-introduce">2.5.5</a></li><li><a class="dropdown__link" href="/docs/2.5.4/phoenix-2.x/phoenix/phoenix-introduce">2.5.4</a></li><li><a class="dropdown__link" href="/docs/2.5.3/phoenix-2.x/phoenix/phoenix-introduce">2.5.3</a></li><li><a class="dropdown__link" href="/docs/2.5.2/phoenix-2.x/phoenix/phoenix-introduce">2.5.2</a></li><li><a class="dropdown__link" href="/docs/2.5.1/phoenix-2.x/phoenix/phoenix-introduce">2.5.1</a></li><li><a class="dropdown__link" href="/docs/2.5.0/phoenix-2.x/phoenix/phoenix-introduce">2.5.0</a></li><li><a class="dropdown__link" href="/docs/2.4.4/phoenix-2.x/phoenix/phoenix-introduce">2.4.4</a></li><li><a class="dropdown__link" href="/docs/2.4.3/phoenix-2.x/phoenix/phoenix-introduce">2.4.3</a></li><li><a class="dropdown__link" href="/docs/2.4.2/phoenix-2.x/phoenix/phoenix-introduce">2.4.2</a></li><li><a class="dropdown__link" href="/docs/2.4.1/phoenix-2.x/phoenix/phoenix-introduce">2.4.1</a></li><li><a class="dropdown__link" href="/docs/2.4.0/phoenix-2.x/phoenix/phoenix-introduce">2.4.0</a></li><li><a class="dropdown__link" href="/docs/2.2.4/phoenix-2.x/phoenix/">2.2.4</a></li></ul></div><a href="https://github.com/PhoenixIQ" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/introduce">Phoenix介绍</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link" href="/docs/phoenix">快速入门</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/phoenix/why-event-driven-microservice">为什么需要事件驱动型微服务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/phoenix/how-event-driven-microservice">Phoenix实现事件驱动型微服务</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/phoenix/quick-start-example">快速入门案例</a><button aria-label="展开侧边栏分类 &#x27;快速入门案例&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/phoenix/phoenix-all-future">功能总览</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/phoenix/phoenix-glossary">Phoenix概念</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/phoenix/upgrade/2-5-x">Release Notes</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/phoenix/license-upgrade">License 升级</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/phoenix/phoenix-faq">FAQ</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/phoenix-core">Phoenix Framework</a><button aria-label="折叠侧边栏分类 &#x27;Phoenix Framework&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/phoenix-core/phoenix-core-client">客户端</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/phoenix-core/phoenix-core-entity-aggregate">实体聚合根</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/phoenix-core/phoenix-core-event-souring">事件溯源</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/phoenix-core/phoenix-core-event-store">事件存储</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/phoenix-core/phoenix-subscribe-pub">订阅与广播</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/phoenix-core/phoenix-cluster-manager">集群管理</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/phoenix-advanced/aggregate-timer">高级特性</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/phoenix-advanced/aggregate-timer">聚合根定时任务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/phoenix-advanced/aggregate-segment">聚合根片段代码</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/phoenix-advanced/phoenix-distributed-data">分布式数据</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/phoenix-advanced/phoenix-kafka-extend">Kafka 扩展</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/phoenix-advanced/starvation-detector">线程池饥饿检测器</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/phoenix-advanced/cluster-pool">集群计算池</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/phoenix-core/phoenix-core-config">配置详情</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/phoenix-core/phoenix-aggregate-test">单元测试</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/phoenix-transaction">Phoenix Transaction</a><button aria-label="展开侧边栏分类 &#x27;Phoenix Transaction&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/phoenix-event-publish/event-publish-readme">Phoenix Event Publish</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/phoenix-dgc/phoenix-dgc-introduce">Phoenix DGC</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/phoenix-observability">Phoenix Observability</a><button aria-label="展开侧边栏分类 &#x27;Phoenix Observability&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/phoenix-test/features-test">测试报告</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/phoenix-core"><span itemprop="name">Phoenix Framework</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">高级特性</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Kafka 扩展</span><meta itemprop="position" content="3"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">版本：latest</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Kafka 扩展</h1></header><p>本文档分为两个部分（都是对 Phoenix-Kafka 能力做的一些扩展）：</p>
<ol>
<li>Kafka 增强扩展：让 Phoenix Kafka Client 支持 LargeMessage 的消息发送</li>
<li>Kafka 分区选择器：为 Phoenix 内部模块消息发送（Producer）定义发送的分区选择策略</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-extend">一. Kafka 增强扩展<a href="#kafka-extend" class="hash-link" aria-label="一. Kafka 增强扩展的直接链接" title="一. Kafka 增强扩展的直接链接">​</a></h2>
<blockquote>
<p>这里的 Kafka 增强扩展只是 Phoenix 对 KafkaClient 的预留了扩展接口, 内置了 Linkedin 的 KafkaClient 作为 Apache KafkaClient
的增强扩展</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-extend-introduce">简介<a href="#kafka-extend-introduce" class="hash-link" aria-label="简介的直接链接" title="简介的直接链接">​</a></h3>
<p>Phoenix 框架为了解决 Kafka 消息传输中的 LargeMessage 问题，提供/预留了可配置 KafkaClient 增强扩展，其中一种解决方案是 Chunk
Message，在探索之后本着不重复造轮子的原则，Phoenix 内置集成了支持 LargeMessage 的
<a href="https://github.com/linkedin/li-apache-kafka-clients" target="_blank" rel="noopener noreferrer">Linkedin Kafka Client</a></p>
<blockquote>
<p>当然，通过更改配置后，Kafka 也支持超过默认大小的消息，Linkedin（原 Kafka 开发者）做了相关的 <a href="https://engineering.linkedin.com/kafka/benchmarking-apache-kafka-2-million-writes-second-three-cheap-machines" target="_blank" rel="noopener noreferrer">Benchmark</a>.</p>
<p>但是不优化的情况下，Large messages 可能会对 Broker 和 JVM 造成影响，然后拖慢 JVM 速度</p>
</blockquote>
<p>当然，除了 Phoenix 的方案外，Kafka Large Message 也有其他解决方案，本文档不具体展开：</p>
<ul>
<li>Kafka 和外部存储中是用基于引用的消息传递（Reference-based）</li>
<li>在 KafkaClient 中使用无需外部存储的内置 Large Message 支持（Phoenix 所用）</li>
<li>内置 Large Message 支持 + 分层存储（tiered storage）</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-extend-scene">使用场景<a href="#kafka-extend-scene" class="hash-link" aria-label="使用场景的直接链接" title="使用场景的直接链接">​</a></h3>
<p>Kafka 扩展（主要是 Large Message 的支持）需要双端使用统一客户端（Consumer、Producer），目前识别到的场景有：</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>信息</div><div class="admonitionContent_BuS1"><p>关于 CLIENT_CONSUMER 等 Phoenix 模块配置在 com.iquantex.phoenix.core.connect.kafka.PhoenixKafkaClientModule 中定义</p></div></div>
<ul>
<li>当聚合根发出/回复的事件大小超出 Kafka 限制时：<code>CLIENT_CONSUMER &lt;-&gt; SERVER_PRODUCER</code>  (用于PhoenixClient RPC
模式下响应的接收)</li>
<li>当 EventPublish 发出的事件大小超出 Kafka 限制时：<code>EVENT_PUBLISH_PRODUCER &lt;-&gt; spring.consumer</code> （用 spring kafka 外部订阅）</li>
<li>当 PhoenixClient 发出的命令大于 Kafka 限制时：<code>CLIENT_PRODUCER &lt;-&gt; SERVER_CONSUMER</code>（用于PhoenixClient RPC、异步模式）</li>
<li>当 KafkaTemplate（spring kafka 客户端）发出的命令大于 Kafka 限制时：<code>spring.producer &lt;-&gt; SERVER_CONSUMER</code>（外部发送给
Phoenix 订阅、也可以是用户的自定义订阅）</li>
<li>不使用 Phoenix，仅使用 Kafka 扩展：<code>spring.producer &lt;-&gt; spring.consumer</code></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-extend-usage">使用说明<a href="#kafka-extend-usage" class="hash-link" aria-label="使用说明的直接链接" title="使用说明的直接链接">​</a></h3>
<p>:::caution 注意
Phoenix Kafka Extend 目前仅支持 K/V 为 <code>&lt;String,byte[]&gt;</code> 的序列化和反序列化. 如果需要支持 <code>&lt;String,String&gt;</code>，请传入时使用 <code>String.getBytes()</code>
或提前将 Value 序列化
:::</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-extend-dependency">0. 引入 Kafka Extend 依赖<a href="#kafka-extend-dependency" class="hash-link" aria-label="0. 引入 Kafka Extend 依赖的直接链接" title="0. 引入 Kafka Extend 依赖的直接链接">​</a></h4>
<p>请注意，<code>phoenix-kafka-extend</code> 依赖 Phoenix 核心 API 包 <code>phoenix-core</code></p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">com.iquantex</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">phoenix-kafka-extend-starter</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">2.6.1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-extend-client">1. Phoenix Client、内部订阅等<a href="#kafka-extend-client" class="hash-link" aria-label="1. Phoenix Client、内部订阅等的直接链接" title="1. Phoenix Client、内部订阅等的直接链接">​</a></h4>
<p>:::tip 提示
当您在 Kubernetes 环境中通过环境变量配置 <code>spring-kafka-properties</code> 时，可以用下面这种格式：</p>
<p><code>QUANTEX_PHOENIX_KAFKA_EXTEND_SPRING-KAFKA-PROPERTIES_BOOTSTRAP_SERVERS</code> 也可以使用 <code>QUANTEX_PHOENIX_KAFKA_EXTEND_SPRING_KAFKA_PROPERTIES_BOOTSTRAP_SERVERS</code>
:::</p>
<p>默认开启配置后，Phoenix 会自动将 Apache Kafka Client 替换成 Linkedin Kafka Clien</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">quantex</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">phoenix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kafka</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">extend</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 是否开启 Phoenix Kafka Extend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 是否让 Server 端对 Client 的回复使用 Kafka 增强 Client （RPC 场景，需要同时开启 client-consumer）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">server-producer-enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 是否让 Client 端接收 Server 的响应使用 Kafka 增强 Client（RPC 场景，需要同时开启 server-producer）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">client-consumer-enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 是否让 Client 端发送给 Server 的命令使用 Kafka 增强 Client（默认消息入口场景，需要同时开启 server-consumer）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">client-producer-enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 是否让 Server 端接收 MQ 订阅使用 Kafka 增强 Client（默认订阅场景，需要同时开启 client-producer 或接收的外部 Client 支持）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">server-consumer-enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 是否让 EventPublish 端发送给外部的消息使用 Kafka 增强 Client（需要外部的 KafkaConsumer 支持增强 Client，可以用 Phoenix-Spring 的集成）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">event-publish-producer-enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 是否开启 Spring Consumer 的 Kafka 增强 Client，Phoenix 会注册一个 ConsumerFactory Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">spring-consumer-enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 是否开启 Spring Producer 的 Kafka 增强 Client，Phoenix 会注册一个 ProducerFactory Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">spring-producer-enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Spring 的 Kafka 增强 Client 的配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">spring-kafka-properties</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">&quot;bootstrap.servers&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 127.0.0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9092</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">127.0.0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9092</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">127.0.0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9092</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Linkedin Kafka 配 置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Producer: 普通消息的最大大小，超出则开始切分. 默认 50kb</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">max-message-bytes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">51200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Consumer: 用于缓冲不完整大消息段的内存总大小上限（默认是 30mb）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">message-buffer-capacity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32000000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Consumer: LargeMessage 起始 Offset 和当前 Offset 最大差距值，超出则认为 Large Message 已不完整。默认 1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">message-expiration-offset-gap</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Consumer: 每个分区要跟踪 Offset 的最大消息数，默认 500 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">max-offset-track-pre-partition</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">500</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-extend-subscribe">2. 自定义订阅<a href="#kafka-extend-subscribe" class="hash-link" aria-label="2. 自定义订阅的直接链接" title="2. 自定义订阅的直接链接">​</a></h4>
<p>:::info 注意事项
当 KafkaExtend 用于扩展时，从 Kafka 接收的消息体积可能会大于 256KB，此时会超出 Phoenix 内部 akka 的限制，如果需要让大于 256KB 的消息发能够
发送到聚合根，则需要更改配置，如更改为 4MB 的相关配置为：（使用 <code>quantex.phoenix.akka.akka-conf</code> 自定义 akka 配置）</p>
<div class="language-CONF language-conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-conf codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">akka.remote.artery.advanced.maximum-frame-size= 4096 KiB</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>:::</p>
<p>当开启 Kafka Extend 后，Phoenix 会向 Spring 注册一个 <code>com.iquantex.phoenix.core.connect.kafka.KafkaClientProvider</code> 的 SpringBean.</p>
<p>用户可以拿到该 Bean 并注册到 KafkaSubscribe 中：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">Subscribe</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">customSubscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">KafkaClientProvider</span><span class="token plain"> clientProvider</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Properties</span><span class="token plain"> properties </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Properties</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    properties</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">putIfAbsent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">AUTO_OFFSET_RESET_CONFIG</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;latest&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">KafkaSubscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mqAddress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            subscribeTopic</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            appName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SelfDeseriSchema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            clientProvider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">PhoenixKafkaClientModule</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">SERVER_CONSUMER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 是用和 SERVER_CONSUMER 一样的配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 假设用户不希望 Server 订阅使用 Kafka Extend，仅对自己的某个自定义订阅需要，则可以是用默认的增强 Consumer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">ConsumerFactory</span><span class="token plain"> factory </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> clientProvider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">PhoenixKafkaClientModule</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">ENHANCE_PRODUCER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-extend-producer">3. Spring Kafka Producer 集成<a href="#kafka-extend-producer" class="hash-link" aria-label="3. Spring Kafka Producer 集成的直接链接" title="3. Spring Kafka Producer 集成的直接链接">​</a></h4>
<p>当用户想要在 Phoenix 外部（其他服务）使用 Phoenix Kafka Extend 时，通过开关，Phoenix 会向 Spring 注册 KafkaClient Factory 的 SpringBean，用户只需要修改 Spring Kafka Client 的配置即可。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * 在注册 KafkaTemplate Bean 时，从 Spring IOC 中取出名为：phoenix-kafka-producer-extend 的 Spring 接口 ProducerFactory 的实现实例. 然后作为 KafkaTemplate 的参数传入 KafkaTemplate</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">KafkaTemplate</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">kafkaTemplate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token annotation punctuation" style="color:#393A34">@Qualifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;phoenix-kafka-producer-extend&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">ProducerFactory</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> producerFactory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">KafkaTemplate</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">producerFactory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-extend-consumer">4. Spring Kafka Consumer 集成<a href="#kafka-extend-consumer" class="hash-link" aria-label="4. Spring Kafka Consumer 集成的直接链接" title="4. Spring Kafka Consumer 集成的直接链接">​</a></h4>
<p>当用户想要在 Phoenix 外部（其他服务）使用 Phoenix Kafka Extend 时，通过开关，Phoenix 会向 Spring 注册 KafkaClient Factory 的 SpringBean，用户只需要修改 Spring Kafka Client 的配置即可。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * 同理，只需要更改 ConcurrentKafkaListenerContainerFactory 的 ConsumerFactory 即可.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * Phoenix 会注入名为 phoenix-kafka-consumer-extend 的 Spring 接口 ConsumerFactory 的实现实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">ConcurrentKafkaListenerContainerFactory</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">kafkaListenerContainerFactory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token annotation punctuation" style="color:#393A34">@Qualifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;phoenix-kafka-consumer-extend&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">ConsumerFactory</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> consumerFactory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">ConcurrentKafkaListenerContainerFactory</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> factory </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ConcurrentKafkaListenerContainerFactory</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setConsumerFactory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">consumerFactory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setBatchListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getContainerProperties</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setAckMode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ContainerProperties</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">AckMode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">MANUAL_IMMEDIATE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> factory</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-extend-internal">内部处理<a href="#kafka-extend-internal" class="hash-link" aria-label="内部处理的直接链接" title="内部处理的直接链接">​</a></h3>
<p>本文档只做简单介绍，详细请参考：<a href="https://github.com/linkedin/li-apache-kafka-clients" target="_blank" rel="noopener noreferrer">https://github.com/linkedin/li-apache-kafka-clients</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-extend-offset">1. Offset<a href="#kafka-extend-offset" class="hash-link" aria-label="1. Offset的直接链接" title="1. Offset的直接链接">​</a></h4>
<p>Kafka Extend 在处理 Large Message 时，会以最后一个 Segment 的 Offset 作为消息的 Offset</p>
<p><img loading="lazy" alt="message" src="/assets/images/kafka-extend-offset-42c16328d644cf51a9cc069d3867fb29.png" width="828" height="363" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-extend-tracking">2. Offset Tracking<a href="#kafka-extend-tracking" class="hash-link" aria-label="2. Offset Tracking的直接链接" title="2. Offset Tracking的直接链接">​</a></h4>
<p>Kafka Extend 会在 Records 的 Header 中添加 Large Message 的信息，并在 Client 内部维护，当 Msg1 的消息传输发生问题时，用户可以从 Msg1 的第一个 Segment 开始消费（seek）</p>
<p><img loading="lazy" alt="message" src="/assets/images/kafka-extend-offset-track-04bfd28dc424b5785353159b5cdc7ee8.png" width="1000" height="495" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-extend-rebalanced">3. Rebalanced<a href="#kafka-extend-rebalanced" class="hash-link" aria-label="3. Rebalanced的直接链接" title="3. Rebalanced的直接链接">​</a></h4>
<p>当 Msg1 未被交付给 User 时，此时重平衡后从 offset=0 开始消费</p>
<p><img loading="lazy" alt="kafka-extend-before-rebalanced.png" src="/assets/images/kafka-extend-before-rebalanced-05dded0cde75ca94df9e82967f229c33.png" width="934" height="403" class="img_ev3q"></p>
<p>当 Msg1 成功交付给 User 之后，Commit 中附加 Header 带上 delivered=2 的信息，并在重平衡后从 offset=3 开始消费并交付给 User</p>
<p><img loading="lazy" alt="kafka-extend-after-rebalanced.png" src="/assets/images/kafka-extend-after-rebalanced-3ac5ead51f883f1d6cc820cf626e76aa.png" width="904" height="323" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-extend-memory-cost">4. 内存开销<a href="#kafka-extend-memory-cost" class="hash-link" aria-label="4. 内存开销的直接链接" title="4. 内存开销的直接链接">​</a></h4>
<ul>
<li>生产者：除了消息切分（splitter）和消息拷贝外，没有额外的内存开销</li>
<li>消费者<!-- -->
<ul>
<li><code>buffer.capacity</code>：消费者会缓存固定长度的消息</li>
<li><code>expiration.offset.gap</code>：当 Offset 和 Large Message 的起始 Offset 超出一个差值，则认为该消息不完全，KafkaExtend 会丢弃该消息</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-extend-perf-cost">5. 性能开销<a href="#kafka-extend-perf-cost" class="hash-link" aria-label="5. 性能开销的直接链接" title="5. 性能开销的直接链接">​</a></h4>
<ul>
<li>额外的消息切分（split）和组装（assemble） Segment 的序列化开销</li>
<li>Consumer 中 MessageBuffer 的开销</li>
<li>Consumer 中 Offset Tracking 的开销（每个消息占用 24 bytes）</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-extend-compatible">6. 兼容性<a href="#kafka-extend-compatible" class="hash-link" aria-label="6. 兼容性的直接链接" title="6. 兼容性的直接链接">​</a></h4>
<p>Linkedin Kafka 相关的 Client 包有：</p>
<ul>
<li><code>com.linkedin.kafka.clients:li-apache-kafka-clients</code>：Phoenix 使用，用于 LargeMessage 支持</li>
<li><code>com.linkedin.kafka:kafka-clients</code>：li-apache-kafka-clients 的依赖，Phoenix 默认排除，可使用 Apache Kafka Client</li>
</ul>
<p>虽然 Linked 的 <code>li-apache-kafka-clients</code>对<code>com.linkedin.kafka:kafka-clients</code>的依赖可使用 Apache Kafka Client 代替，但仍然有一些方法是 Linkedin Kafka Client 独有的。
因此，假设用户需要更好的 <code>li-apache-kafka-clients</code> 支持，请使用 Linkedin 自己的 KafkaClient（和 Apache Kafka Client 冲突，类名几乎一致） 请根据自身需要选择。</p>
<p>在 Kafka Extend 中使用 Apache Kafka Client 可能会遇到一些兼容问题，例如 Producer flush() 方法的 <code>NoSuchMethodException</code>.(不支持 Timeout，不影响主流程，会走入旁路)</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-extend-router">7. 消息路由<a href="#kafka-extend-router" class="hash-link" aria-label="7. 消息路由的直接链接" title="7. 消息路由的直接链接">​</a></h4>
<p>此处的消息路由是指 Kafka 超大消息经过 KafkaExtend 处理之后的后续路径，通常来说在仅使用 KafkaExtend 的 Producer 下时没有任何问题的（因为已经是在 Phoenix 中
消息流转的最后一步。当 KafkaExtend 用于订阅时，可能会让消息超出 Phoenix 内部消息流转的大小限制（256KB）。下面分别是影响的路径和不影响的路径：</p>
<ul>
<li>EventPublish KafkaProducer：不受影响，消息不会在集群内传递</li>
<li>DistributionData Broadcast；不受影响，消息不会在集群内传递</li>
<li>PhoenixServer Producer：（通常用于回复 PhoenixClient 实现 RPC ）不受影响，在这里消息会跨 Actor，但不会跨 JVM，跨集群节点</li>
<li>Spring KafkaProducer：此阶段不受影响，取决于 Producer 发往的 Topic 是否是由 Phoenix 消费</li>
<li>Spring KafkaConsumer：不受影响，这里是直接由用户代码处理消息，不经过 Phoenix 集群及 Actor 处理</li>
<li>PhoenixClient：此阶段不受影响，但后续发往的 PhoenixServer 处理可能会受影响</li>
<li>PhoenixServer Subscribe：受影响，主要是发往聚合根的 Command 大小会被 Phoenix 内部的 Actor 通信大小所限制（可配置更高）</li>
</ul>
<p>对于 Phoenix 集群内部的大体积“命令”的消息传输，目前可以通过配置 Akka 配置：<code>akka.remote.artery.advanced.maximum-frame-size</code> 短暂支持。
但更大体积的消息传输意味着更高的丢失概率，即使在可靠交付的保证下，也会让消息的延迟增加；并且这个配置存在上限，对于超大体积（大于 10MB），则不建议用这种方式。</p>
<p>后续 Phoenix 会支持内部大体积消息的 Chunk Message（分块传输），这能让 Phoenix 内部支持上超大体积的（大于 10MB）消息传输</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="partition-selector">二. 自定义 Kafka 分区选择器<a href="#partition-selector" class="hash-link" aria-label="二. 自定义 Kafka 分区选择器的直接链接" title="二. 自定义 Kafka 分区选择器的直接链接">​</a></h2>
<p>Phoenix 支持对 KafkaProducer 发送的消息实现分区选择策略, 支持配置的模块如下：</p>
<ul>
<li>phoenix-client：消息发送到 Server 订阅的主 Topic 时，分区的选择策略</li>
<li>phoenix-server: 消息响应/回复到 PhoenixClient/其他回复路径的 Topic 时，分区的选择策略</li>
<li>phoenix-event-publish：事件投递通过 EventPublish 投递时，分区的选择策略</li>
<li>phoenix-distribution-data：分布式数据发布更新事件时，分区的选择策略</li>
</ul>
<p>:::tip 提示
除了作为分区选择器之外，该接口实现也可以用于监控用途. 例如在内部采集流量后, 返回 -1 的分区号，此时 Phoenix 不会选定投递的分区，而是让 Kafka 根据 Key 自行决定。
:::</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="partition-selector-api">接口实现<a href="#partition-selector-api" class="hash-link" aria-label="接口实现的直接链接" title="接口实现的直接链接">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">PartitionSelector</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/** 选择 Kafka 默认的分区策略. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">KAFKA_DEFAULT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * 通过消息的key选择一个目标分区</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * @param key {@link org.apache.kafka.clients.producer.ProducerRecord} Key</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * @param topic Topic</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * @param partitionInfos Topic Partitions</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token plain"> topic</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">PartitionInfo</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> partitionInfos</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="partition-selector-config">配置实现<a href="#partition-selector-config" class="hash-link" aria-label="配置实现的直接链接" title="配置实现的直接链接">​</a></h3>
<p>下面所示的配置并非默认值，而是当用户不自定义时选择的&quot;默认分区选择器&quot;，Spring 配置的默认值为 null</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">quantex</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">phoenix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">client</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">mq</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 自定义分区选择器实现（发送到 Phoenix MQ 订阅）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">partition-selector-class-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> com.iquantex.phoenix.core.connect.kafka.OriginPartitionSelector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">mq</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 自定义分区选择器实现（回复给 Client Topic）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">partition-selector-class-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> com.iquantex.phoenix.core.connect.kafka.OriginPartitionSelector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">event-publish</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">event-task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 自定义分区选择器实现（EventPublish 到指定 Topic）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">partition-selector-class-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> com.iquantex.phoenix.eventpublish.mq.kafka.DefaultKafkaPartitionSelector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">d-data-task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 自定义分区选择器实现（DData 发送到 Phoenix MQ 订阅）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">partition-selector-class-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> com.iquantex.phoenix.eventpublish.mq.kafka.DefaultKafkaPartitionSelector</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="faq">FAQ<a href="#faq" class="hash-link" aria-label="FAQ的直接链接" title="FAQ的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="no-such-method">1. KafkaProducer NoSuchMethodException<a href="#no-such-method" class="hash-link" aria-label="1. KafkaProducer NoSuchMethodException的直接链接" title="1. KafkaProducer NoSuchMethodException的直接链接">​</a></h3>
<p>正常现象，不影响主流程，参考兼容性问题</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[ WARN] [ispatcher-27] [c.producer.LiKafkaProducerImpl]: Wrapped KafkaProducer does not support time-bounded flush. MDC: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">java.lang.NoSuchMethodException: org.apache.kafka.clients.producer.KafkaProducer.flush(long, java.util.concurrent.TimeUnit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at java.lang.Class.getMethod(Class.java:1786)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.linkedin.kafka.clients.producer.LiKafkaProducerImpl.&lt;init&gt;(LiKafkaProducerImpl.java:188)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.linkedin.kafka.clients.producer.LiKafkaProducerImpl.&lt;init&gt;(LiKafkaProducerImpl.java:154)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.iquantex.phoenix.client.mq.impl.kafka.LinkedKafkaProducerFactory.createProducer(LinkedKafkaProducerFactory.java:26)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.iquantex.phoenix.core.connect.kafka.KafkaServerProducer.init(KafkaServerProducer.java:85)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.iquantex.phoenix.server.akka.SenderActor.preStart(SenderActor.java:39)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at akka.actor.Actor.aroundPreStart(Actor.scala:548)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at akka.actor.Actor.aroundPreStart$(Actor.scala:548)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at akka.actor.AbstractActor.aroundPreStart(AbstractActor.scala:220)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at akka.actor.ActorCell.create(ActorCell.scala:643)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at akka.actor.ActorCell.invokeAll$1(ActorCell.scala:513)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at akka.actor.ActorCell.systemInvoke(ActorCell.scala:535)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at akka.dispatch.Mailbox.processAllSystemMessages(Mailbox.scala:295)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at akka.dispatch.Mailbox.run(Mailbox.scala:230)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at java.lang.Thread.run(Thread.java:750)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="uncaught">2. Uncaught exception in thread &#x27;kafka-producer-network-thread<a href="#uncaught" class="hash-link" aria-label="2. Uncaught exception in thread &#x27;kafka-producer-network-thread的直接链接" title="2. Uncaught exception in thread &#x27;kafka-producer-network-thread的直接链接">​</a></h3>
<p>这是因为 Linkedin Kafka Client 不支持部分方法，和 Spring 的兼容有点问题，解决方案是不在 Spring KafkaTemplate 中是用 KafkaExtend</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[2023-06-01 14:53:25,197] [ERROR] [| producer-9] [kafka.common.utils.KafkaThread]: Uncaught exception in thread &#x27;kafka-producer-network-thread | producer-9&#x27;: MDC: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">java.lang.AbstractMethodError: Method com/linkedin/kafka/clients/producer/LiKafkaProducerImpl.close(Ljava/time/Duration;)V is abstract</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.linkedin.kafka.clients.producer.LiKafkaProducerImpl.close(LiKafkaProducerImpl.java)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.springframework.kafka.core.KafkaTemplate.closeProducer(KafkaTemplate.java:382)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.springframework.kafka.core.KafkaTemplate.lambda$buildCallback$4(KafkaTemplate.java:433)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.linkedin.kafka.clients.producer.LiKafkaProducerImpl$ErrorLoggingCallback.onCompletion(LiKafkaProducerImpl.java:525)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.linkedin.kafka.clients.largemessage.LargeMessageCallback.onCompletion(LargeMessageCallback.java:49)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.producer.KafkaProducer$InterceptorCallback.onCompletion(KafkaProducer.java:1348)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.producer.internals.ProducerBatch.completeFutureAndFireCallbacks(ProducerBatch.java:227)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.producer.internals.ProducerBatch.done(ProducerBatch.java:196)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.producer.internals.Sender.completeBatch(Sender.java:707)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.producer.internals.Sender.completeBatch(Sender.java:688)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.producer.internals.Sender.handleProduceResponse(Sender.java:596)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.producer.internals.Sender.access$100(Sender.java:74)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.producer.internals.Sender$1.onComplete(Sender.java:798)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.ClientResponse.onComplete(ClientResponse.java:109)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.NetworkClient.completeResponses(NetworkClient.java:569)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.NetworkClient.poll(NetworkClient.java:561)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.producer.internals.Sender.runOnce(Sender.java:335)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:244)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at java.lang.Thread.run(Thread.java:750)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="shard-num">3. 分区选择器的分区数量问题<a href="#shard-num" class="hash-link" aria-label="3. 分区选择器的分区数量问题的直接链接" title="3. 分区选择器的分区数量问题的直接链接">​</a></h3>
<p>分区选择器的分区数量仅会在第一次获取时通过 KafkaClient <code>partitionsFor(String topic)</code> 获取，然后此结果被缓存用于加速。</p>
<p>当 Topic 的分区数量改变时，Phoenix 仍以本地内存缓存为准，而不会主动更新分区数量（这一点也体现在 Phoenix 的 MQ 订阅上）</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="oversize">4. OversizedPayloadException<a href="#oversize" class="hash-link" aria-label="4. OversizedPayloadException的直接  链接" title="4. OversizedPayloadException的直接链接">​</a></h3>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">akka.remote.OversizedPayloadException: Discarding oversized payload sent to ... : max allowed size 262144 bytes, actual size of encoded ... was ... bytes.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这是因为发送的消息大小超出了 Phoenix 默认消息的 256KB 大小的限制，如需要更改为 4MB 的相关配置为：（使用 <code>quantex.phoenix.akka.akka-conf</code> 自定义 akka 配置）</p>
<div class="language-CONF language-conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-conf codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">akka.remote.artery.advanced.maximum-frame-size = 4096 KiB</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代  码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="method-error">5. java.lang.AbstractMethodError<a href="#method-error" class="hash-link" aria-label="5. java.lang.AbstractMethodError的直接链接" title="5. java.lang.AbstractMethodError的直接链接">​</a></h3>
<p>在 spring-kafka 版本是 2.5.x 及以上时（例如 spring-boot 2.3.7.RELEASE）使用 <code>phoenix-kafka-extend</code> 会导致该错误，完整错误信息如下：</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">java.lang.AbstractMethodError: com.linkedin.kafka.clients.consumer.LiKafkaConsumerImpl.committed(Ljava/util/Set;)Ljava/util/Map;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这是因为 2.5.x 版本的 Spring kafka 的 KafkaMessageListenerContainer 使用了一个  <code>phoenix-kafka-extend</code> 中 Linkined Kafka Client 未实现的 KafkaConsumer 批量提交方法.</p>
<p>在 KafkaMessageListenerContainer 源码中，该方法有个前置条件：<code>commitCurrentOnAssignment</code>，我们可以通过该条件跳过该方法，从而解决 Linkined Kafka Client 未实现 <code>commited(Set&lt;TopicPartitions&gt; topicPartitions)</code> 的问题</p>
<p><img loading="lazy" alt="source" src="/assets/images/kafka-extend-spring-error_01-bf9ec4a78cd2f165414fba2f80978cce.png" width="1353" height="471" class="img_ev3q"></p>
<p>通过该前置条件的赋值方法，我们可以通过修改 ContainerProperties.AssignmentCommitOption 来简单解决此问题</p>
<p><img loading="lazy" alt="source" src="/assets/images/kafka-extend-spring-error_02-7b6ea4731a60dc36ecf1ca1e8bcdfbac.png" width="1743" height="663" class="img_ev3q"></p>
<p>解决方案如下，同理，在 commitCurrentOnAssignment 的赋值方法 <code>determineCommitCurrent()</code> 通过走向其他分支（最终必须是 false）来实现跳过也能简单修复此问题。</p>
<p>除此之外，也可以通过降级等方式解决此问题。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">ConcurrentKafkaListenerContainerFactory</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">kafkaListenerContainerFactory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Qualifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;phoenix-kafka-consumer-extend&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">ConsumerFactory</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> consumerFactory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ConcurrentKafkaListenerContainerFactory</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> factory </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ConcurrentKafkaListenerContainerFactory</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setConsumerFactory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">consumerFactory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setBatchListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getContainerProperties</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setAckMode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ContainerProperties</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">AckMode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">MANUAL_IMMEDIATE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 避免 Spring Kafka 使用批量 Commited</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getContainerProperties</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setAssignmentCommitOption</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ContainerProperties</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">AssignmentCommitOption</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">NEVER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> factory</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="large-message-send">6. LargeMessageSendException<a href="#large-message-send" class="hash-link" aria-label="6. LargeMessageSendException的直接链接" title="6. LargeMessageSendException 的直接链接">​</a></h3>
<p>这种情况是配置的 <code>quantex.phoenix.kafka.extend.max-message-bytes</code> 与 Kafka Server 的最大消息大小不匹配，Kafka Extend 要求此配置低于 Kafka Server 的配置大小，这是因为 Kafka Extend 会在拆分的消息中附加一些元数据（消息分了多少批来发送，消息总长度，消息序号等）</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0000-00-00 00:00:00] [ERROR] [| producer-3] [c.producer.LiKafkaProducerImpl]: Unable to send event [No Custom Info] with message id e7cfbd58b48445a2b28df03c03ba7226 to kafka topic xxxx-xxxx-xxx MDC: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">com.linkedin.kafka.clients.largemessage.errors.LargeMessageSendException: Error when sending large message. Sent 1 of 11 segments.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.linkedin.kafka.clients.largemessage.LargeMessageCallback.onCompletion(LargeMessageCallback.java:53)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.producer.KafkaProducer$InterceptorCallback.onCompletion(KafkaProducer.java:1348)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.producer.internals.ProducerBatch.completeFutureAndFireCallbacks(ProducerBatch.java:227)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.producer.internals.ProducerBatch.done(ProducerBatch.java:196)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.producer.internals.Sender.completeBatch(Sender.java:707)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.producer.internals.Sender.completeBatch(Sender.java:688)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.producer.internals.Sender.handleProduceResponse(Sender.java:596)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.producer.internals.Sender.access$100(Sender.java:74)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.producer.internals.Sender$1.onComplete(Sender.java:798)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.ClientResponse.onComplete(ClientResponse.java:109)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.NetworkClient.completeResponses(NetworkClient.java:569)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.NetworkClient.poll(NetworkClient.java:561)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.producer.internals.Sender.runOnce(Sender.java:335)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at org.apache.kafka.clients.producer.internals.Sender.run(Sender.java:244)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at java.lang.Thread.run(Thread.java:750)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: org.apache.kafka.common.errors.RecordTooLargeException: The request included a message larger than the max message size the server will accept.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="invalid">7. InvalidProtocolBufferException<a href="#invalid" class="hash-link" aria-label="7. InvalidProtocolBufferException的直接链接" title="7. InvalidProtocolBufferException的直接链接">​</a></h3>
<p>这种情况下，主要是发送端使用了 Kafka Extend，并发送了超出 <code>quantex.phoenix.kafka.extend.max-message-bytes</code> 大小的事件，但接收端未正确配置成 Kafka Extend 的消费者。</p>
<p>如果是 Spring Kafka Listener，则需要修改 <code>org.springframework.kafka.config.ConcurrentKafkaListenerContainerFactory</code> 中的 ConsumerFactory 为 Kafka Extend 的 Spring Bean.</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Caused by: com.google.protobuf.InvalidProtocolBufferException: Protocol message contained an invalid tag (zero).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.google.protobuf.InvalidProtocolBufferException.invalidTag(InvalidProtocolBufferException.java:105)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.google.protobuf.CodedInputStream$ArrayDecoder.readTag(CodedInputStream.java:609)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.iquantex.phoenix.core.message.protobuf.Phoenix$Message.&lt;init&gt;(Phoenix.java:637)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.iquantex.phoenix.core.message.protobuf.Phoenix$Message.&lt;init&gt;(Phoenix.java:593)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.iquantex.phoenix.core.message.protobuf.Phoenix$Message$1.parsePartialFrom(Phoenix.java:4687)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.iquantex.phoenix.core.message.protobuf.Phoenix$Message$1.parsePartialFrom(Phoenix.java:4681)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.google.protobuf.AbstractParser.parsePartialFrom(AbstractParser.java:163)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.google.protobuf.AbstractParser.parseFrom(AbstractParser.java:197)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.google.protobuf.AbstractParser.parseFrom(AbstractParser.java:209)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.google.protobuf.AbstractParser.parseFrom(AbstractParser.java:214)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.google.protobuf.AbstractParser.parseFrom(AbstractParser.java:49)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.iquantex.phoenix.core.message.protobuf.Phoenix$Message.parseFrom(Phoenix.java:2213)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.iquantex.phoenix.core.message.Message.&lt;init&gt;(Message.java:40)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	at com.iquantex.phoenix.eventpublish.deserializer.DefaultMessageDeserializer.deserialize(DefaultMessageDeserializer.java:21)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	... 24 common frames omitted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="scene">8. 适用场景/不适用场景<a href="#scene" class="hash-link" aria-label="8. 适用场景/不适用场景的直接链接" title="8. 适用场景/不适用场景的直接链接">​</a></h3>
<p>Kafka Extend 适用于部分，低频的消息中存在较大的体积的场景，使用 Kafka Extend 时并不会总是将消息拆分成分块，普通事件（大小低于<code>quantex.phoenix.kafka.extend.max-message-bytes</code>）总是会按照原来的方式传递。</p>
<p>Kafka Extend 不适用于频繁、多数的消息都是较大体积的场景，如每秒 1000 笔 10mb 大小的消息，这种情况下几乎要求 Kafka Broker 支持 10gb/s 的磁盘写入速度，特别是聚合根频繁使用大体积事件，这会导致数据库压力过大，最后导致消息积压，
又会导致内存压力过大。</p>
<p>如，默认配置下 EventPublish 是读取 128 行数据为一个批次，内存上最多存储 64 个批次，此时内存上最多能拥有 8192 ~= 8GB（假设一行的数据/事件大小是 1MB），这会导致 JVM 发生 OOM。</p>
<p>因此 Kafka Extend 支持大体积消息并不意味着 Phoenix 用户在聚合根及业务设计上不用考虑内存开销。相反，使用了 Kafka Extend 意味着了放开了消息体积的限制，那么更应该谨慎考虑背后所带来的内存开销。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/PhoenixIQ/docs/09-phoenix-advanced/04-kafka-extend.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/phoenix-advanced/phoenix-distributed-data"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">分布式数据</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/phoenix-advanced/starvation-detector"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">线程池饥饿检测器</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#kafka-extend" class="table-of-contents__link toc-highlight">一. Kafka 增强扩展</a><ul><li><a href="#kafka-extend-introduce" class="table-of-contents__link toc-highlight">简介</a></li><li><a href="#kafka-extend-scene" class="table-of-contents__link toc-highlight">使用场景</a></li><li><a href="#kafka-extend-usage" class="table-of-contents__link toc-highlight">使用说明</a><ul><li><a href="#kafka-extend-dependency" class="table-of-contents__link toc-highlight">0. 引入 Kafka Extend 依赖</a></li><li><a href="#kafka-extend-client" class="table-of-contents__link toc-highlight">1. Phoenix Client、内部订阅等</a></li><li><a href="#kafka-extend-subscribe" class="table-of-contents__link toc-highlight">2. 自定义订阅</a></li><li><a href="#kafka-extend-producer" class="table-of-contents__link toc-highlight">3. Spring Kafka Producer 集成</a></li><li><a href="#kafka-extend-consumer" class="table-of-contents__link toc-highlight">4. Spring Kafka Consumer 集成</a></li></ul></li><li><a href="#kafka-extend-internal" class="table-of-contents__link toc-highlight">内部处理</a><ul><li><a href="#kafka-extend-offset" class="table-of-contents__link toc-highlight">1. Offset</a></li><li><a href="#kafka-extend-tracking" class="table-of-contents__link toc-highlight">2. Offset Tracking</a></li><li><a href="#kafka-extend-rebalanced" class="table-of-contents__link toc-highlight">3. Rebalanced</a></li><li><a href="#kafka-extend-memory-cost" class="table-of-contents__link toc-highlight">4. 内存开销</a></li><li><a href="#kafka-extend-perf-cost" class="table-of-contents__link toc-highlight">5. 性能开销</a></li><li><a href="#kafka-extend-compatible" class="table-of-contents__link toc-highlight">6. 兼容性</a></li><li><a href="#kafka-extend-router" class="table-of-contents__link toc-highlight">7. 消息路由</a></li></ul></li></ul></li><li><a href="#partition-selector" class="table-of-contents__link toc-highlight">二. 自定义 Kafka 分区选择器</a><ul><li><a href="#partition-selector-api" class="table-of-contents__link toc-highlight">接口实现</a></li><li><a href="#partition-selector-config" class="table-of-contents__link toc-highlight">配置实现</a></li></ul></li><li><a href="#faq" class="table-of-contents__link toc-highlight">FAQ</a><ul><li><a href="#no-such-method" class="table-of-contents__link toc-highlight">1. KafkaProducer NoSuchMethodException</a></li><li><a href="#uncaught" class="table-of-contents__link toc-highlight">2. Uncaught exception in thread &#39;kafka-producer-network-thread</a></li><li><a href="#shard-num" class="table-of-contents__link toc-highlight">3. 分区选择器的分区数量问题</a></li><li><a href="#oversize" class="table-of-contents__link toc-highlight">4. OversizedPayloadException</a></li><li><a href="#method-error" class="table-of-contents__link toc-highlight">5. java.lang.AbstractMethodError</a></li><li><a href="#large-message-send" class="table-of-contents__link toc-highlight">6. LargeMessageSendException</a></li><li><a href="#invalid" class="table-of-contents__link toc-highlight">7. InvalidProtocolBufferException</a></li><li><a href="#scene" class="table-of-contents__link toc-highlight">8. 适用场景/不适用场景</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/introduce">Phoenix介绍</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/phoenix/quick-start-example/bookings-architecture">快速入门</a></li></ul></div><div class="col footer__col"><div class="footer__title">案例</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/PhoenixIQ/phoenix-samples/tree/master/bank-account" target="_blank" rel="noopener noreferrer" class="footer__link-item">账户管理<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/PhoenixIQ/phoenix-sample-risk" target="_blank" rel="noopener noreferrer" class="footer__link-item">交易风控<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/PhoenixIQ/phoenix-samples/tree/master/shopping-cart" target="_blank" rel="noopener noreferrer" class="footer__link-item">购物车<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/PhoenixIQ/hotel-booking" target="_blank" rel="noopener noreferrer" class="footer__link-item">酒店预订<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">资源</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">博客</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">北京宽拓智融科技有限公司 Copyright @2013 - 2023 iQuantex.com All Rights Reserved. 宽拓公司 版权所有</div></div></div></footer></div>
</body>
</html>